<?php
/**
 * Plugin Name: Advanced Order Status Chains for WooCommerce
 * Description: Adds custom order statuses and automated status transitions.
 * Author: Your Name
 * Version: 1.1
 */

if (!defined('ABSPATH')) exit; // Prevent direct access

/**
 * ğŸ›  Register Custom Order Statuses
 */
function register_custom_order_statuses() {
    $statuses = [
        'wc-paid'          => 'ÄÃ£ CK',
        'wc-packaging' => 'Chuáº©n bá»‹ giao VC',
        'wc-shipping'      => 'Äang giao',
        'wc-local-shipping' => 'Giao nhanh',
        'wc-delivered'     => 'ÄÃ£ giao',
    ];

    foreach ($statuses as $key => $label) {
        register_post_status($key, array(
            'label'                     => $label,
            'public'                    => true,
            'exclude_from_search'       => false,
            'show_in_admin_all_list'     => true,
            'show_in_admin_status_list'  => true,
            'label_count'                => _n_noop("$label <span class='count'>(%s)</span>", "$label <span class='count'>(%s)</span>", 'woocommerce'),
        ));
    }
}
add_action('init', 'register_custom_order_statuses');

/**
 * ğŸ›  Add Custom Statuses to WooCommerce Order Status List
 */
function add_custom_wc_order_statuses($order_statuses) {
    $new_statuses = [];
    foreach ($order_statuses as $key => $status) {
        $new_statuses[$key] = $status;

        if ('wc-on-hold' === $key) {
            $new_statuses['wc-paid'] = 'ÄÃ£ CK';
        }
        if ('wc-processing' === $key) {
            $new_statuses['wc-packaging'] = 'Chuáº©n bá»‹ giao VC';
        }
        $new_statuses['wc-shipping'] = 'Äang giao';
        $new_statuses['wc-local-shipping'] = 'Giao nhanh';
        $new_statuses['wc-delivered'] = 'ÄÃ£ giao';
    }
    return $new_statuses;
}
add_filter('wc_order_statuses', 'add_custom_wc_order_statuses');

/**
 * ğŸ”„ Define Custom Order Status Transitions
 */
function custom_order_status_transitions($order_id, $old_status, $new_status) {
    $order = wc_get_order($order_id);
    
    // Chain: Paid â†’ Shipping â†’ Delivered â†’ Completed
    if ($new_status === 'wc-paid') {
        $order->update_status('wc-shipping');
    } elseif ($new_status === 'wc-shipping') {
        $order->update_status('wc-delivered');
    } elseif ($new_status === 'wc-delivered') {
        $order->update_status('completed');
    }

    // Chain: Processing (COD) â†’ Packaging (COD) â†’ Shipping â†’ Delivered â†’ Completed
    if ($new_status === 'wc-packaging') {
        $order->update_status('wc-shipping');
    }

    // Chain: On Hold / Processing â†’ Local Shipping â†’ Delivered â†’ Completed
    if ($new_status === 'wc-local-shipping') {
        $order->update_status('wc-delivered');
    }
}
add_action('woocommerce_order_status_changed', 'custom_order_status_transitions', 10, 3);

/**
 * ğŸ’° Add "Mark as Paid" Button in Admin Orders
 */
function add_mark_paid_button($actions, $order) {
    if ($order->has_status(['on-hold', 'processing'])) {
        $actions['mark_paid'] = [
            'url'  => wp_nonce_url(admin_url('admin-ajax.php?action=mark_order_paid&order_id=' . $order->get_id()), 'mark_order_paid'),
            'name' => __('Mark as Paid', 'woocommerce'),
            'icon' => 'âœ…'
        ];
    }
    return $actions;
}
add_filter('woocommerce_admin_order_actions', 'add_mark_paid_button', 10, 2);

/**
 * ğŸ“ Handle "Mark as Paid" Action with Payment Details
 */
function handle_mark_order_paid() {
    if (!current_user_can('edit_shop_orders') || !check_admin_referer('mark_order_paid')) {
        wp_die(__('Unauthorized request.', 'woocommerce'));
    }

    $order_id = isset($_GET['order_id']) ? absint($_GET['order_id']) : 0;
    if (!$order_id) {
        wp_die(__('Invalid order ID.', 'woocommerce'));
    }

    $order = wc_get_order($order_id);
    if (!$order) {
        wp_die(__('Order not found.', 'woocommerce'));
    }

    // Prompt for payment details
    echo '<form method="post" action="' . esc_url(admin_url('admin-ajax.php')) . '">
            <input type="hidden" name="action" value="save_paid_details">
            <input type="hidden" name="order_id" value="' . esc_attr($order_id) . '">
            <label>Received Account:</label>
            <input type="text" name="received_account" required><br>
            <label>Paid Date:</label>
            <input type="date" name="paid_date" required><br>
            <input type="submit" value="Save Payment Details">
          </form>';
    exit;
}
add_action('wp_ajax_mark_order_paid', 'handle_mark_order_paid');

/**
 * ğŸ’¾ Save Payment Details & Change Order Status
 */
function save_paid_details() {
    if (!current_user_can('edit_shop_orders')) {
        wp_die(__('Unauthorized request.', 'woocommerce'));
    }

    $order_id = isset($_POST['order_id']) ? absint($_POST['order_id']) : 0;
    $received_account = sanitize_text_field($_POST['received_account']);
    $paid_date = sanitize_text_field($_POST['paid_date']);

    if (!$order_id || !$received_account || !$paid_date) {
        wp_die(__('Missing required fields.', 'woocommerce'));
    }

    $order = wc_get_order($order_id);
    $order->update_meta_data('received_account', $received_account);
    $order->update_meta_data('paid_date', $paid_date);
    $order->set_payment_method('bacs'); // Change payment method to BACS
    $order->update_status('wc-paid', __('Payment received & updated.', 'woocommerce'));
    $order->save();

    wp_redirect(admin_url('edit.php?post_type=shop_order'));
    exit;
}
add_action('wp_ajax_save_paid_details', 'save_paid_details');

